# Dex Helm Chart Values
# Official chart: https://charts.dexidp.io

image:
  repository: ghcr.io/dexidp/dex
  tag: v2.44.0

replicaCount: 2

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi

config:
  issuer: https://auth.ops.last-try.org

  storage:
    type: kubernetes
    config:
      inCluster: true

  web:
    http: 0.0.0.0:5556

  connectors:
    - type: github
      id: github
      name: GitHub
      config:
        clientID: $GITHUB_CLIENT_ID
        clientSecret: $GITHUB_CLIENT_SECRET
        redirectURI: https://auth.ops.last-try.org/callback
        orgs:
          - name: hitchai-app

  staticClients:
    # OAuth2 Proxy for dev-ui (stage)
    - id: oauth2-proxy-dev-ui-stage
      redirectURIs:
        - 'https://app-stage.steady.ops.last-try.org/oauth2/callback'
      name: 'dev-ui Stage OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_DEV_UI_STAGE

    # OAuth2 Proxy for dev-ui (prod)
    - id: oauth2-proxy-dev-ui-prod
      redirectURIs:
        - 'https://app.steady.ops.last-try.org/oauth2/callback'
      name: 'dev-ui Prod OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_DEV_UI_PROD

    # Grafana (native OIDC)
    - id: grafana
      redirectURIs:
        - 'https://grafana.ops.last-try.org/login/generic_oauth'
      name: 'Grafana'
      secretEnv: DEX_CLIENT_SECRET_GRAFANA

    # ArgoCD (native OIDC)
    - id: argocd
      redirectURIs:
        - 'https://argocd.ops.last-try.org/auth/callback'
      name: 'ArgoCD'
      secretEnv: DEX_CLIENT_SECRET_ARGOCD

    # OAuth2 Proxy for Longhorn
    - id: oauth2-proxy-longhorn
      redirectURIs:
        - 'https://longhorn.ops.last-try.org/oauth2/callback'
      name: 'Longhorn OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_LONGHORN

    # OAuth2 Proxy for Alertmanager
    - id: oauth2-proxy-alertmanager
      redirectURIs:
        - 'https://alertmanager.ops.last-try.org/oauth2/callback'
      name: 'Alertmanager OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_ALERTMANAGER

    # OAuth2 Proxy for Prometheus
    - id: oauth2-proxy-prometheus
      redirectURIs:
        - 'https://prometheus.ops.last-try.org/oauth2/callback'
      name: 'Prometheus OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_PROMETHEUS

    # OAuth2 Proxy for SigNoz
    - id: oauth2-proxy-signoz
      redirectURIs:
        - 'https://signoz.ops.last-try.org/oauth2/callback'
      name: 'SigNoz OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_SIGNOZ

  staticPasswords: []

  logger:
    level: info
    format: json

# Environment variables from sealed secret
envVars:
  - name: GITHUB_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: github-client-id
  - name: GITHUB_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: github-client-secret
  - name: DEX_CLIENT_SECRET_DEV_UI_STAGE
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: dev-ui-stage-client-secret
  - name: DEX_CLIENT_SECRET_DEV_UI_PROD
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: dev-ui-prod-client-secret
  - name: DEX_CLIENT_SECRET_GRAFANA
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: grafana-client-secret
  - name: DEX_CLIENT_SECRET_ARGOCD
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: argocd-client-secret
  - name: DEX_CLIENT_SECRET_LONGHORN
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: longhorn-client-secret
  - name: DEX_CLIENT_SECRET_ALERTMANAGER
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: alertmanager-client-secret
  - name: DEX_CLIENT_SECRET_PROMETHEUS
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: prometheus-client-secret
  - name: DEX_CLIENT_SECRET_SIGNOZ
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: signoz-client-secret

service:
  type: ClusterIP
  ports:
    http:
      port: 5556
