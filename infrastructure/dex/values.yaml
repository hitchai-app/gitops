# Dex Helm Chart Values
# Official chart: https://charts.dexidp.io

image:
  repository: ghcr.io/dexidp/dex
  tag: v2.44.0

replicaCount: 2

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi

config:
  issuer: https://auth.ops.last-try.org

  storage:
    type: kubernetes
    config:
      inCluster: true

  web:
    http: 0.0.0.0:5556

  # Enable local password database for static users
  enablePasswordDB: true

  connectors:
    - type: github
      id: github
      name: GitHub
      config:
        clientID: $GITHUB_CLIENT_ID
        clientSecret: $GITHUB_CLIENT_SECRET
        redirectURI: https://auth.ops.last-try.org/callback
        orgs:
          - name: hitchai-app
          # No teams specified = fetch all teams user is member of
          # Groups will be returned as: hitchai-app:<team-slug>

  staticClients:
    # Grafana (native OIDC)
    - id: grafana
      redirectURIs:
        - 'https://grafana.ops.last-try.org/login/generic_oauth'
      name: 'Grafana'
      secretEnv: DEX_CLIENT_SECRET_GRAFANA

    # ArgoCD (native OIDC)
    - id: argocd
      redirectURIs:
        - 'https://argocd.ops.last-try.org/auth/callback'
      name: 'ArgoCD'
      secretEnv: DEX_CLIENT_SECRET_ARGOCD

    # OAuth2 Proxy for Longhorn
    - id: oauth2-proxy-longhorn
      redirectURIs:
        - 'https://longhorn.ops.last-try.org/oauth2/callback'
      name: 'Longhorn OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_LONGHORN

    # OAuth2 Proxy for Alertmanager
    - id: oauth2-proxy-alertmanager
      redirectURIs:
        - 'https://am.ops.last-try.org/oauth2/callback'
      name: 'Alertmanager OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_ALERTMANAGER

    # OAuth2 Proxy for Prometheus
    - id: oauth2-proxy-prometheus
      redirectURIs:
        - 'https://prometheus.ops.last-try.org/oauth2/callback'
      name: 'Prometheus OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_PROMETHEUS

    # Forgejo (native OIDC)
    - id: forgejo
      redirectURIs:
        - 'https://git.ops.last-try.org/user/oauth2/dex/callback'
      name: 'Forgejo'
      secretEnv: DEX_CLIENT_SECRET_FORGEJO

    # GitLab (OIDC)
    # Redirect URI uses /auth/dex/ because GitLab omniauth args.name="dex"
    - id: gitlab
      redirectURIs:
        - 'https://gitlab.ops.last-try.org/users/auth/dex/callback'
      name: 'GitLab'
      secretEnv: DEX_CLIENT_SECRET_GITLAB

    # GlitchTip (native OIDC via django-allauth)
    # Callback URL format: /accounts/oidc/{provider_id}/login/callback/
    - id: glitchtip
      redirectURIs:
        - 'https://glitchtip.ops.last-try.org/accounts/oidc/dex/login/callback/'
      name: 'GlitchTip'
      secretEnv: DEX_CLIENT_SECRET_GLITCHTIP

    # Sentry (OIDC via sentry-auth-oidc)
    - id: sentry
      redirectURIs:
        - 'https://sentry.ops.last-try.org/auth/sso/'
      name: 'Sentry'
      secretEnv: DEX_CLIENT_SECRET_SENTRY

    # OAuth2 Proxy for Green Admin (shared across stage/prod/PRs)
    # Single callback URL - oauth2-proxy handles redirect back to original URL
    - id: oauth2-proxy-green-admin
      redirectURIs:
        - 'https://oauth.green.ops.last-try.org/oauth2/callback'
      name: 'Green Admin OAuth2 Proxy'
      secretEnv: DEX_CLIENT_SECRET_GREEN_ADMIN

    # StandaLock (native OIDC)
    - id: standalock
      redirectURIs:
        - 'https://standalock.ops.last-try.org/auth/callback'
      name: 'StandaLock'
      secretEnv: DEX_CLIENT_SECRET_STANDALOCK

  # Static users for local authentication (bcrypt hashed passwords)
  # Generate hash: htpasswd -bnBC 10 "" 'password' | tr -d ':\n' | sed 's/$2y/$2a/'
  # Note: Bcrypt hashes are safe in git (they're already hashed)
  staticPasswords:
    - email: "admin@ops.last-try.org"
      hash: "$2a$10$e8.34e9CEoZzmQk8aj45ROMUUPxM3pQcUHNmMGUp7Pcl8/C0OGRJO"
      username: admin
      userID: "admin-001"
    - email: "george@ops.last-try.org"
      hash: "$2a$10$x4jJ3D/hVlV.IXTrRIavieFpTox2j54j5aG3pUmu5V7N5h6/Q7De6"
      username: george
      userID: "george-002"
    - email: "flawless@ops.last-try.org"
      hash: "$2a$10$RrHv7R854IWMmn6SXu.VD.D/KC9iR7rRJpN1o91MgLxvgWkkcArL."
      username: flawless
      userID: "flawless-003"

  logger:
    level: info
    format: json

# Environment variables from sealed secret
envVars:
  - name: GITHUB_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: github-client-id
  - name: GITHUB_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: github-client-secret
  - name: DEX_CLIENT_SECRET_GRAFANA
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: grafana-client-secret
  - name: DEX_CLIENT_SECRET_ARGOCD
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: argocd-client-secret
  - name: DEX_CLIENT_SECRET_LONGHORN
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: longhorn-client-secret
  - name: DEX_CLIENT_SECRET_ALERTMANAGER
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: alertmanager-client-secret
  - name: DEX_CLIENT_SECRET_PROMETHEUS
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: prometheus-client-secret
  - name: DEX_CLIENT_SECRET_FORGEJO
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: forgejo-client-secret
  - name: DEX_CLIENT_SECRET_GITLAB
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: gitlab-client-secret
  - name: DEX_CLIENT_SECRET_GLITCHTIP
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: glitchtip-client-secret
  - name: DEX_CLIENT_SECRET_SENTRY
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: sentry-client-secret
  - name: DEX_CLIENT_SECRET_GREEN_ADMIN
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: green-admin-client-secret
  - name: DEX_CLIENT_SECRET_STANDALOCK
    valueFrom:
      secretKeyRef:
        name: dex-secrets
        key: DEX_CLIENT_SECRET_STANDALOCK

service:
  type: ClusterIP
  ports:
    http:
      port: 5556
