alertmanager:
  alertmanagerSpec:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    storage:
      volumeClaimTemplate:
        spec:
          # Single-node cluster: use single-replica StorageClass (no redundancy yet).
          storageClassName: single-replica
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi
    secrets:
      - alertmanager-discord-webhook
  config: |
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname','namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h
      receiver: discord
    receivers:
      - name: discord
        webhook_configs:
          - url_file: /etc/alertmanager/secrets/alertmanager-discord-webhook/url
            send_resolved: true

grafana:
  ingress:
    enabled: true
    ingressClassName: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - grafana.ops.last-try.org
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.ops.last-try.org
  persistence:
    enabled: true
    storageClassName: single-replica
    accessModes:
      - ReadWriteOnce
    size: 2Gi
  serviceMonitor:
    enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Dex OIDC Authentication
  grafana.ini:
    server:
      root_url: https://grafana.ops.last-try.org

    auth.generic_oauth:
      enabled: true
      name: Dex
      allow_sign_up: true
      client_id: grafana
      client_secret: $__file{/etc/secrets/oauth/client-secret}
      scopes: openid profile email groups
      auth_url: https://auth.ops.last-try.org/auth
      token_url: https://auth.ops.last-try.org/token
      api_url: https://auth.ops.last-try.org/userinfo
      allowed_domains: ""
      # Users in hitchai-app GitHub org get Admin, others get Viewer
      role_attribute_path: contains(groups[*], 'hitchai-app') && 'Admin' || 'Viewer'

  # Mount OAuth client secret from sealed secret
  extraSecretMounts:
    - name: oauth-secret
      secretName: grafana-oauth-secret
      defaultMode: 0440
      mountPath: /etc/secrets/oauth
      readOnly: true

prometheus:
  prometheusSpec:
    retention: 7d
    retentionSize: 15GiB
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        cpu: "2"
        memory: 3Gi
    storageSpec:
      volumeClaimTemplate:
        spec:
          # Single-node cluster: use single-replica StorageClass (no redundancy yet).
          storageClassName: single-replica
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
    podMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
