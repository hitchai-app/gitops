apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # Discord webhook service (URL from sealed secret)
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json

  # Template for successful deployment
  template.app-deployed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "üöÄ {{.app.metadata.name}} deployed",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "description": "Application synced successfully",
              "color": 3066993,
              "fields": [
                {
                  "name": "Environment",
                  "value": "{{.app.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "Sync Status",
                  "value": "{{.app.status.sync.status}}",
                  "inline": true
                },
                {
                  "name": "Health",
                  "value": "{{.app.status.health.status}}",
                  "inline": true
                },
                {
                  "name": "Revision",
                  "value": "`{{.app.status.sync.revision}}`",
                  "inline": false
                }
              ],
              "timestamp": "{{.app.status.operationState.finishedAt}}"
            }]
          }

  # Template for sync failure
  template.app-sync-failed: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "‚ùå {{.app.metadata.name}} sync failed",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "description": "Application failed to sync",
              "color": 15158332,
              "fields": [
                {
                  "name": "Environment",
                  "value": "{{.app.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "Sync Status",
                  "value": "{{.app.status.sync.status}}",
                  "inline": true
                },
                {
                  "name": "Error",
                  "value": "{{.app.status.operationState.message}}",
                  "inline": false
                }
              ],
              "timestamp": "{{.app.status.operationState.finishedAt}}"
            }]
          }

  # Template for health degraded
  template.app-health-degraded: |
    webhook:
      discord:
        method: POST
        body: |
          {
            "embeds": [{
              "title": "‚ö†Ô∏è {{.app.metadata.name}} health degraded",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "description": "Application health status changed",
              "color": 16776960,
              "fields": [
                {
                  "name": "Environment",
                  "value": "{{.app.metadata.namespace}}",
                  "inline": true
                },
                {
                  "name": "Health Status",
                  "value": "{{.app.status.health.status}}",
                  "inline": true
                },
                {
                  "name": "Sync Status",
                  "value": "{{.app.status.sync.status}}",
                  "inline": true
                }
              ]
            }]
          }

  # Trigger: on successful deployment
  trigger.on-deployed: |
    - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
      send: [app-deployed]

  # Trigger: on sync failure
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  # Trigger: on health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Default subscriptions for all apps
  subscriptions: |
    - recipients:
      - discord
      triggers:
      - on-deployed
      - on-sync-failed
      - on-health-degraded
