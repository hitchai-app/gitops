# Forgejo Helm Chart Values
# Chart: forgejo-helm/forgejo
# Reference: https://code.forgejo.org/forgejo-helm/forgejo-helm

replicaCount: 1

image:
  registry: code.forgejo.org
  repository: forgejo/forgejo
  pullPolicy: IfNotPresent
  rootless: true

# Persistence
persistence:
  enabled: true
  size: 10Gi
  storageClass: single-replica
  accessModes:
    - ReadWriteOnce

# Resources
resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    memory: 1Gi

# Service
service:
  http:
    type: ClusterIP
    port: 3000
  ssh:
    type: LoadBalancer
    port: 2222
    annotations:
      metallb.universe.tf/allow-shared-ip: "default"

# Ingress managed separately
ingress:
  enabled: false

# Disable bundled PostgreSQL - use external CloudNativePG
postgresql:
  enabled: false

# Disable bundled PostgreSQL-HA
postgresql-ha:
  enabled: false

# Disable bundled Redis - not needed for single-node
redis-cluster:
  enabled: false

# Forgejo configuration
gitea:
  # No local admin - use Dex OIDC
  admin:
    existingSecret: ""

  config:
    APP_NAME: "Forgejo: Git Ops"

    server:
      DOMAIN: git.ops.last-try.org
      ROOT_URL: https://git.ops.last-try.org
      SSH_DOMAIN: git.ops.last-try.org
      SSH_PORT: 2222
      DISABLE_SSH: false
      START_SSH_SERVER: true

    database:
      DB_TYPE: postgres
      # Connection string from CloudNativePG secret
      HOST: forgejo-postgres-rw
      NAME: forgejo
      USER: forgejo
      SCHEMA: public

    session:
      PROVIDER: db

    cache:
      ADAPTER: memory

    queue:
      TYPE: level

    indexer:
      ISSUE_INDEXER_TYPE: bleve

    repository:
      ROOT: /data/git/repositories
      DEFAULT_BRANCH: main

    service:
      DISABLE_REGISTRATION: true
      REQUIRE_SIGNIN_VIEW: false
      ENABLE_NOTIFY_MAIL: false

    mailer:
      ENABLED: false

    openid:
      ENABLE_OPENID_SIGNIN: false
      ENABLE_OPENID_SIGNUP: false

    # OAuth2 settings
    oauth2:
      ENABLED: true

    oauth2_client:
      ENABLE_AUTO_REGISTRATION: true
      ACCOUNT_LINKING: auto
      UPDATE_AVATAR: true
      USERNAME: nickname

    log:
      LEVEL: Info

    # Enable packages/container registry
    packages:
      ENABLED: true
      CHUNKED_UPLOAD_PATH: /data/tmp/package-upload

    # S3 storage for packages (MinIO)
    storage:
      STORAGE_TYPE: minio
      MINIO_ENDPOINT: infra-hl.minio-infra.svc.cluster.local:9000
      MINIO_BUCKET: forgejo-packages
      MINIO_USE_SSL: false
      MINIO_INSECURE_SKIP_VERIFY: true

    "storage.packages":
      STORAGE_TYPE: minio

    # Actions integration (for ACTIONS_RUNTIME_TOKEN)
    actions:
      ENABLED: true
      DEFAULT_ACTIONS_URL: https://code.forgejo.org

  # Database password from CloudNativePG secret
  additionalConfigFromEnvs:
    - name: FORGEJO__database__PASSWD
      valueFrom:
        secretKeyRef:
          name: forgejo-postgres-app
          key: password
    # MinIO credentials for package storage
    - name: FORGEJO__storage__MINIO_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: forgejo-minio-credentials
          key: access-key
    - name: FORGEJO__storage__MINIO_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: forgejo-minio-credentials
          key: secret-key
