---
# Job to configure Dex OAuth2 authentication source
# Runs after Forgejo is ready to add OIDC provider
# Note: Due to Gitea/Forgejo caching bug (github.com/go-gitea/gitea/issues/8356),
# Forgejo may need restart after first OAuth source creation
apiVersion: batch/v1
kind: Job
metadata:
  name: forgejo-oauth-setup
  namespace: forgejo-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: oauth-setup
          image: code.forgejo.org/forgejo/forgejo:10
          command:
            - /bin/sh
            - -c
            - |
              set -e
              CONFIG="/data/gitea/conf/app.ini"

              echo "Waiting for Forgejo to be ready..."
              sleep 10

              echo "Checking if Dex auth source exists..."
              if /usr/local/bin/gitea admin auth list --config "$CONFIG" 2>/dev/null | grep -q "dex"; then
                echo "Dex auth source already exists, skipping"
                exit 0
              fi

              echo "Adding Dex OAuth2 authentication source..."
              /usr/local/bin/gitea admin auth add-oauth \
                --config "$CONFIG" \
                --name "dex" \
                --provider "openidConnect" \
                --key "forgejo" \
                --secret "${OIDC_CLIENT_SECRET}" \
                --auto-discover-url "https://auth.ops.last-try.org/.well-known/openid-configuration" \
                --scopes "openid email profile groups" \
                --group-claim-name "groups" \
                --admin-group "hitchai-app:admins" \
                --skip-local-2fa

              echo "OAuth2 source added successfully"
              echo "Note: Forgejo may need restart to recognize new auth source (see gitea#8356)"
          env:
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: forgejo-oidc
                  key: client-secret
            - name: GITEA_WORK_DIR
              value: /data
            - name: GITEA_CUSTOM
              value: /data/gitea
          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: gitea-shared-storage
