apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-prod
  namespace: postgres-prod
spec:
  instances: 1

  imageName: ghcr.io/cloudnative-pg/postgresql:17.2

  storage:
    storageClass: longhorn-single-replica
    size: 20Gi

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 2Gi

  monitoring:
    enablePodMonitor: true

  backup:
    retentionPolicy: "30d"
    barmanObjectStore:
      destinationPath: s3://cloudnativepg-backups/postgres-prod
      s3Credentials:
        accessKeyId:
          name: backup-s3-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: backup-s3-credentials
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
        encryption: AES256
        maxParallel: 2
      data:
        compression: gzip
        encryption: AES256
        jobs: 2

  bootstrap:
    initdb:
      database: app
      owner: app
      encoding: "UTF8"
      localeCollate: "en_US.UTF-8"
      localeCType: "en_US.UTF-8"
