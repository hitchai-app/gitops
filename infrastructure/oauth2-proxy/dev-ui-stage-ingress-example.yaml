# Example Ingress for dev-ui (stage) with OAuth2 Proxy protection
#
# This shows how to update the dev-ui ingress to route through oauth2-proxy.
# The actual ingress is managed in the steady-stage workload repository.
#
# BEFORE (no auth):
#   User → Traefik → dev-ui:3000
#
# AFTER (with auth):
#   User → Traefik → oauth2-proxy:4180 → dev-ui:3000
#                         ↓ (if not authenticated)
#                       Dex login

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dev-ui
  namespace: steady-stage
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - app-stage.steady.ops.last-try.org
    secretName: dev-ui-tls
  rules:
  - host: app-stage.steady.ops.last-try.org
    http:
      paths:
      # OAuth2 Proxy handles authentication
      - path: /oauth2
        pathType: Prefix
        backend:
          service:
            name: oauth2-proxy-dev-ui
            port:
              number: 4180
      # All other requests go through oauth2-proxy
      # OAuth2 Proxy will validate token and proxy to dev-ui
      - path: /
        pathType: Prefix
        backend:
          service:
            name: oauth2-proxy-dev-ui  # Changed from: dev-ui
            port:
              number: 4180              # Changed from: 3000
