# Shared Valkey StatefulSet
# ADR Reference: 0005-statefulset-for-valkey.md
# Single replica, AOF persistence, redis_exporter sidecar
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: valkey
  namespace: valkey
spec:
  serviceName: valkey
  replicas: 1
  selector:
    matchLabels:
      app: valkey
  template:
    metadata:
      labels:
        app: valkey
    spec:
      containers:
        # Main Valkey container
        - name: valkey
          image: valkey/valkey:8.0.2-alpine
          command:
            - /bin/sh
            - -c
            - |
              # Calculate maxmemory at ~80% of cgroup limit
              CGROUP_LIMIT=$(cat /sys/fs/cgroup/memory.max 2>/dev/null || cat /sys/fs/cgroup/memory/memory.limit_in_bytes 2>/dev/null || echo "max")
              if [ "$CGROUP_LIMIT" = "max" ] || [ -z "$CGROUP_LIMIT" ]; then
                MAXMEMORY="800mb"  # Fallback for 1Gi limit
              else
                MAXMEMORY=$(( CGROUP_LIMIT * 80 / 100 / 1024 / 1024 ))mb
              fi
              echo "Setting maxmemory to $MAXMEMORY"
              exec valkey-server \
                --appendonly yes \
                --appendfsync everysec \
                --maxmemory "$MAXMEMORY" \
                --maxmemory-policy noeviction \
                --save "" \
                --bind 0.0.0.0
          ports:
            - containerPort: 6379
              name: redis
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          volumeMounts:
            - name: data
              mountPath: /data
          livenessProbe:
            exec:
              command: ["valkey-cli", "ping"]
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            exec:
              command: ["valkey-cli", "ping"]
            initialDelaySeconds: 5
            periodSeconds: 5

        # redis_exporter sidecar for Prometheus metrics
        - name: exporter
          image: oliver006/redis_exporter:v1.61.0
          ports:
            - containerPort: 9121
              name: metrics
          env:
            - name: REDIS_ADDR
              value: "redis://localhost:6379"
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi

  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: longhorn
        resources:
          requests:
            storage: 5Gi
