# Sentry self-hosted Helm values
# Uses external databases managed by operators
hostname: sentry.ops.last-try.org

# Use existing Secret managed by SealedSecret instead of Helm hook
# This prevents conflict between Helm-created Secret and SealedSecret controller
sentry:
  existingSecret: sentry-sentry-secret

# Disable bundled services - using external operators
clickhouse:
  enabled: false

kafka:
  enabled: false

postgresql:
  enabled: false

redis:
  enabled: false

zookeeper:
  enabled: false

# External PostgreSQL (CloudNativePG with TLS cert auth)
externalPostgresql:
  host: sentry-postgres-rw.sentry-system.svc.cluster.local
  port: 5432
  database: sentry
  username: sentry
  existingSecret: sentry-postgres-app
  existingSecretKeys:
    password: password
  # CNPG-managed TLS; use password auth
  sslMode: require

# External ClickHouse (Altinity operator with TLS cert auth)
externalClickhouse:
  host: sentry-clickhouse-sentry-0.sentry-system.svc.cluster.local
  httpPort: 8123
  tcpPort: 9000
  database: default
  username: default
  # No password - using TLS client certificate authentication

# External Kafka (Strimzi operator with mTLS)
externalKafka:
  cluster:
    - host: sentry-kafka-kafka-bootstrap.sentry-system.svc.cluster.local
      port: 9092

# External Redis/Valkey (SAP operator with TLS)
externalRedis:
  host: valkey-sentry-primary.sentry-system.svc.cluster.local
  port: 6379
  # No password - using TLS client certificate authentication
  ssl: true

# Disable user registration, require SSO
auth:
  register: false

# Resource limits for single-node cluster
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# Mount TLS client certificates into Sentry pods
extraVolumeMounts:
  - name: client-certs
    mountPath: /etc/sentry/tls
    readOnly: true
  - name: ca-cert
    mountPath: /etc/sentry/ca
    readOnly: true

extraVolumes:
  - name: client-certs
    secret:
      secretName: sentry-client-tls
  - name: ca-cert
    secret:
      secretName: sentry-ca-tls
      items:
        - key: tls.crt
          path: ca.crt

# Enable metrics for Prometheus
serviceMonitor:
  enabled: true

# Extend sentry.conf.py with Redis TLS CA config
config:
  sentryConfPy: |
    SENTRY_OPTIONS["redis.clusters"]["default"]["hosts"][0]["ssl_ca_certs"] = "/etc/sentry/ca/ca.crt"
