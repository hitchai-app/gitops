# Sentry self-hosted Helm values
# Bundled Kafka/Redis/ClickHouse, external Postgres via CNPG
hostname: sentry.ops.last-try.org

# Use embedded ingress (Traefik) with cert-manager TLS
ingress:
  enabled: true
  regexPathStyle: traefik
  ingressClassName: traefik
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hostname: sentry.ops.last-try.org
  tls:
    - secretName: sentry.ops.last-try.org-tls
      hosts:
        - sentry.ops.last-try.org

# Custom Sentry image with OIDC plugin (sentry-auth-oidc)
images:
  sentry:
    # Update this tag (and infrastructure/sentry/oidc/image-tag.txt) after rebuilding the custom image
    repository: ghcr.io/hitchai-app/sentry-oidc
    tag: 25.12.1-oidc

# Use existing Secret managed by SealedSecret instead of Helm hook
# This prevents conflict between Helm-created Secret and SealedSecret controller
sentry:
  existingSecret: sentry-sentry-secret
  web:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://dex.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://dex.ops.last-try.org
  worker:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://dex.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://dex.ops.last-try.org
  cron:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://dex.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://dex.ops.last-try.org

config:
  sentryConfPy: |-
    from sentry.conf.server import *  # noqa
    OIDC_CLIENT_ID = os.environ.get("OIDC_CLIENT_ID")
    OIDC_CLIENT_SECRET = os.environ.get("OIDC_CLIENT_SECRET")
    OIDC_SCOPE = os.environ.get("OIDC_SCOPE", "openid profile email")
    OIDC_DOMAIN = os.environ.get("OIDC_DOMAIN")
    OIDC_ISSUER = os.environ.get("OIDC_ISSUER")
    AUTH_PROVIDERS = AUTH_PROVIDERS + (
      ("sentry_auth_oidc", {"name": "OIDC"}),
    )

# Enable bundled services
clickhouse:
  enabled: true

kafka:
  enabled: true

postgresql:
  enabled: false

redis:
  enabled: true

zookeeper:
  enabled: true

# External PostgreSQL (CloudNativePG with TLS cert auth)
externalPostgresql:
  host: sentry-postgres-rw.sentry-system.svc.cluster.local
  port: 5432
  database: sentry
  username: sentry
  existingSecret: sentry-postgres-app
  existingSecretKeys:
    password: password
  # CNPG-managed TLS; use password auth
  sslMode: require

# Disable user registration, require SSO
auth:
  register: false

# Resource limits for single-node cluster
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# Enable metrics for Prometheus
serviceMonitor:
  enabled: true
