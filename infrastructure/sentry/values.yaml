# Sentry self-hosted Helm values
# Bundled Kafka/Redis/ClickHouse, external Postgres via CNPG
hostname: sentry.ops.last-try.org

# Use embedded ingress (Traefik) with cert-manager TLS
ingress:
  enabled: true
  regexPathStyle: traefik
  ingressClassName: traefik
  hostname: sentry.ops.last-try.org
  tls:
    - secretName: sentry.ops.last-try.org-tls
      hosts:
        - sentry.ops.last-try.org

# Custom Sentry image with OIDC plugin (sentry-auth-oidc)
images:
  sentry:
    # Tag must match Sentry chart appVersion (from apps/infrastructure/sentry.yaml).
    # Workflow derives appVersion from chart and builds ${appVersion}-oidc.
    repository: ghcr.io/hitchai-app/sentry-oidc
    tag: 25.12.1-oidc

# Use existing Secret managed by SealedSecret instead of Helm hook
# This prevents conflict between Helm-created Secret and SealedSecret controller
sentry:
  existingSecret: sentry-sentry-secret
  web:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://auth.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://auth.ops.last-try.org
  worker:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://auth.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://auth.ops.last-try.org
  cron:
    env:
      - name: OIDC_CLIENT_ID
        value: sentry
      - name: OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: dex-secrets
            key: sentry-client-secret
      - name: OIDC_SCOPE
        value: "openid profile email"
      - name: OIDC_DOMAIN
        value: https://auth.ops.last-try.org
      - name: OIDC_ISSUER
        value: https://auth.ops.last-try.org

config:
  configYml:
    system.url-prefix: "https://sentry.ops.last-try.org"
  sentryConfPy: |-
    OIDC_CLIENT_ID = os.environ.get("OIDC_CLIENT_ID")
    OIDC_CLIENT_SECRET = os.environ.get("OIDC_CLIENT_SECRET")
    OIDC_SCOPE = os.environ.get("OIDC_SCOPE", "openid profile email")
    OIDC_DOMAIN = os.environ.get("OIDC_DOMAIN")
    OIDC_ISSUER = os.environ.get("OIDC_ISSUER")
    if isinstance(AUTH_PROVIDERS, dict):
      AUTH_PROVIDERS["sentry_auth_oidc"] = {"name": "OIDC"}
    else:
      AUTH_PROVIDERS = AUTH_PROVIDERS + (
        ("sentry_auth_oidc", {"name": "OIDC"}),
      )
    CSRF_TRUSTED_ORIGINS = ["https://sentry.ops.last-try.org"]
    SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")

# Disable bundled services (using operator-managed ClickHouse and Kafka)
clickhouse:
  enabled: false

kafka:
  enabled: false

postgresql:
  enabled: false

redis:
  enabled: true

zookeeper:
  enabled: false

# External ClickHouse (operator-managed)
externalClickhouse:
  host: chi-sentry-sentry-0-0.sentry-system.svc.cluster.local
  port: 9000
  username: sentry
  existingSecret: sentry-clickhouse-auth
  existingSecretKeys:
    password: clickhouse-password

# External Kafka (operator-managed)
externalKafka:
  host: sentry-kafka-kafka-bootstrap.sentry-system.svc.cluster.local
  port: 9092
  bootstrapServers: sentry-kafka-kafka-bootstrap.sentry-system.svc.cluster.local:9092

# External PostgreSQL (CloudNativePG with TLS cert auth)
externalPostgresql:
  host: sentry-postgres-rw.sentry-system.svc.cluster.local
  port: 5432
  database: sentry
  username: sentry
  existingSecret: sentry-postgres-app
  existingSecretKeys:
    password: password
  # CNPG-managed TLS; use password auth
  sslMode: require

# Disable user registration, require SSO
auth:
  register: false

# Disable Helm hook jobs; ArgoCD runs explicit migration hooks instead.
hooks:
  enabled: false

# Resource limits for single-node cluster
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# Enable metrics for Prometheus
serviceMonitor:
  enabled: true
