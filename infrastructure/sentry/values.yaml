# Sentry Helm Chart Values
# Chart: sentry-kubernetes/charts v27.7.0
# Reference: https://github.com/sentry-kubernetes/charts

# Admin user configuration
user:
  create: true
  email: admin@ops.last-try.org
  password: ""  # Will use existingSecret
  existingSecret: sentry-admin-secret
  existingSecretKey: admin-password

# Initialize on first install
asHook: true

# Disable bundled PostgreSQL - use external CloudNativePG
postgresql:
  enabled: false

# External PostgreSQL (CloudNativePG)
externalPostgresql:
  host: sentry-postgres-rw
  port: 5432
  username: sentry
  database: sentry
  existingSecret: sentry-postgres-app
  existingSecretKeys:
    password: password

# Disable bundled Redis - use external Valkey
redis:
  enabled: false

# External Redis/Valkey
externalRedis:
  host: sentry-valkey-primary
  port: 6379
  existingSecret: sentry-valkey
  existingSecretKey: valkey-password

# Sentry configuration
sentry:
  singleOrganization: true

  web:
    replicas: 1
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        memory: 2Gi

  worker:
    replicas: 1
    resources:
      requests:
        cpu: 300m
        memory: 1Gi
      limits:
        memory: 2Gi

  ingestConsumer:
    replicas: 1
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi

  ingestMetricsConsumerPerf:
    replicas: 1
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi

  billingMetricsConsumer:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

  cron:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

# Python configuration
config:
  sentryConfPy: |
    # System URL for links in emails and API responses
    SENTRY_OPTIONS["system.url-prefix"] = "https://sentry.ops.last-try.org"

    # Event retention: 30 days
    SENTRY_OPTIONS["system.event-retention-days"] = 30

    # Disable anonymous usage statistics
    SENTRY_BEACON = False

    # Rate limiting
    SENTRY_RATELIMITER = "sentry.ratelimits.redis.RedisRateLimiter"

    # TODO: OIDC configuration requires sentry-auth-oidc plugin
    # This needs a custom image or init container to install:
    # pip install sentry-auth-oidc
    # Then configure:
    # OIDC_CLIENT_ID = "sentry"
    # OIDC_CLIENT_SECRET = os.environ.get("OIDC_CLIENT_SECRET")
    # OIDC_ISSUER = "https://auth.ops.last-try.org"
    # OIDC_SCOPE = "openid email profile"

# Relay configuration
relay:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

# Symbolicator for native crash processing
symbolicator:
  enabled: true
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

# Vroom for profiling
vroom:
  enabled: true
  replicas: 1
  persistence:
    enabled: true
    storageClass: single-replica
    size: 10Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

# ClickHouse (bundled - required for analytics)
clickhouse:
  enabled: true
  clickhouse:
    replicas: "1"
    persistentVolumeClaim:
      enabled: true
      dataPersistentVolume:
        enabled: true
        storageClassName: single-replica
        storage: 50Gi
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        memory: 4Gi

# Kafka (bundled - required for event streaming)
kafka:
  enabled: true
  controller:
    replicaCount: 1
    persistence:
      enabled: true
      storageClass: single-replica
      size: 20Gi
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        memory: 2Gi

# RabbitMQ (bundled - task queue)
rabbitmq:
  enabled: true
  replicaCount: 1
  persistence:
    enabled: true
    storageClass: single-replica
    size: 8Gi
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      memory: 1Gi

# Snuba (ClickHouse query layer)
snuba:
  api:
    replicas: 1
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi

  consumer:
    replicas: 1
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        memory: 1Gi

  outcomesConsumer:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

  replacer:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

# Memcached (bundled - caching)
memcached:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

# Disable nginx ingress - we use Traefik
nginx:
  enabled: false

ingress:
  enabled: false  # We manage ingress separately

# Hook configuration
hooks:
  enabled: true
  activeDeadlineSeconds: 600
  dbCheck:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
  dbInit:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
  snubaInit:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi

# Cleanup job for old data
sentry-cleanup:
  enabled: true
  days: 30
  schedule: "0 0 * * *"  # Daily at midnight
