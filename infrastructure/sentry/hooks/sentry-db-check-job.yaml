apiVersion: batch/v1
kind: Job
metadata:
  name: sentry-db-check
  namespace: sentry-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,BeforeHookCreation
    argocd.argoproj.io/sync-wave: "0"
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        sentry.ops.last-try.org/job: db-check
    spec:
      restartPolicy: Never
      containers:
        - name: db-check
          image: alpine:3.20
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache netcat-openbsd >/dev/null
              echo "Checking Postgres..."
              until nc -z sentry-postgres-rw.sentry-system.svc.cluster.local 5432; do
                echo "Postgres not ready, sleeping 5s"; sleep 5;
              done
              echo "Checking ClickHouse..."
              until nc -z sentry-clickhouse 9000; do
                echo "ClickHouse not ready, sleeping 5s"; sleep 5;
              done
              echo "Checking Kafka..."
              until nc -z sentry-kafka 9092; do
                echo "Kafka not ready, sleeping 5s"; sleep 5;
              done
              echo "All dependencies are reachable."
