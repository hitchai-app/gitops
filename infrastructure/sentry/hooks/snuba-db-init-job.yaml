apiVersion: batch/v1
kind: Job
metadata:
  name: sentry-snuba-db-init
  namespace: sentry-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,BeforeHookCreation
    argocd.argoproj.io/sync-wave: "2"
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        sentry.ops.last-try.org/job: snuba-db-init
    spec:
      restartPolicy: Never
      containers:
        - name: snuba-init
          # Keep in sync with Sentry chart appVersion.
          image: ghcr.io/getsentry/snuba:25.12.1
          imagePullPolicy: IfNotPresent
          command:
            - snuba
            - bootstrap
            - --no-migrate
            - --kafka
            - --force
          env:
            - name: SNUBA_SETTINGS
              value: /etc/snuba/settings.py
            - name: DEFAULT_BROKERS
              value: sentry-kafka-kafka-bootstrap:9092
            - name: KAFKA_SECURITY_PROTOCOL
              value: PLAINTEXT
            - name: CLICKHOUSE_MAX_CONNECTIONS
              value: "100"
            - name: REDIS_PORT
              value: "6379"
            - name: CLICKHOUSE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sentry-clickhouse-auth
                  key: clickhouse-password
          envFrom:
            - secretRef:
                name: sentry-snuba-env
          volumeMounts:
            - name: config
              mountPath: /etc/snuba
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: sentry-snuba
