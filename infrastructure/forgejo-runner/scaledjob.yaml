---
apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: forgejo-runner
  namespace: forgejo-runner
spec:
  jobTargetRef:
    parallelism: 1
    completions: 1
    backoffLimit: 0
    ttlSecondsAfterFinished: 300
    template:
      spec:
        restartPolicy: Never
        # Allow running jobs time to complete on pod termination
        terminationGracePeriodSeconds: 300
        initContainers:
          # Set ownership on action cache PVC (root-owned by default, runner runs as UID 1000)
          - name: init-cache-permissions
            image: busybox:1.36
            command:
              - sh
              - -c
              - chown 1000:1000 /cache
            volumeMounts:
              - name: act-action-cache
                mountPath: /cache
          # Copy .runner from secret to writable emptyDir
          - name: copy-runner-config
            image: busybox:1.36
            command:
              - sh
              - -c
              - cp /secret/.runner /data/.runner && chmod 666 /data/.runner
            volumeMounts:
              - name: runner-data
                mountPath: /data
              - name: runner-registration
                mountPath: /secret
          # Native sidecar pattern (K8s 1.29+) - ARC-style
          - name: dind
            image: docker:27-dind
            restartPolicy: Always
            args:
              - dockerd
              - --host=unix:///var/run/docker.sock
              - --group=0
              # Use local registry cache for Docker Hub images
              - --registry-mirror=http://dockerhub-cache-docker-registry.registry-cache.svc.cluster.local:5000
            securityContext:
              privileged: true
            # Startup probe ensures Docker is ready before runner starts
            startupProbe:
              exec:
                command:
                  - docker
                  - info
              initialDelaySeconds: 0
              failureThreshold: 24
              periodSeconds: 5
            volumeMounts:
              - name: docker-graph
                mountPath: /var/lib/docker
              - name: dind-sock
                mountPath: /var/run
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 2000m
                memory: 4Gi
        containers:
          - name: runner
            image: code.forgejo.org/forgejo/runner:6.3.1
            command:
              - forgejo-runner
              - one-job
              - --config
              - /config/config.yaml
            env:
              - name: DOCKER_HOST
                value: unix:///var/run/docker.sock
            volumeMounts:
              - name: runner-data
                mountPath: /data
              - name: runner-config
                mountPath: /config
              - name: dind-sock
                mountPath: /var/run
              - name: act-action-cache
                mountPath: /data/.cache/act
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 4000m
                memory: 4Gi
        volumes:
          - name: docker-graph
            emptyDir: {}
          - name: runner-data
            emptyDir: {}
          - name: dind-sock
            emptyDir: {}
          - name: act-action-cache
            persistentVolumeClaim:
              claimName: act-action-cache
          - name: runner-registration
            secret:
              secretName: forgejo-runner-registration
          - name: runner-config
            configMap:
              name: forgejo-runner-config
  pollingInterval: 5
  minReplicaCount: 0
  maxReplicaCount: 5
  rollout:
    strategy: gradual
  scalingStrategy:
    strategy: accurate
  triggers:
    - type: forgejo-runner
      metadata:
        name: forgejo-runner-keda
        address: "https://git.ops.last-try.org"
        labels: "ubuntu-latest,docker"
        global: "true"
      authenticationRef:
        name: forgejo-runner-auth
