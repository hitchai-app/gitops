---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: actions-cache-server
  namespace: forgejo-runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: actions-cache-server
  template:
    metadata:
      labels:
        app: actions-cache-server
    spec:
      containers:
        - name: cache-server
          image: ghcr.io/falcondev-oss/github-actions-cache-server:8.1.4
          ports:
            - containerPort: 3000
          env:
            - name: API_BASE_URL
              value: "http://actions-cache-server.forgejo-runner.svc.cluster.local:3000"
            - name: STORAGE_DRIVER
              value: "s3"
            - name: STORAGE_S3_BUCKET
              value: "actions-cache"
            - name: AWS_ENDPOINT_URL
              value: "https://infra-hl.minio-infra.svc.cluster.local:9000"
            - name: AWS_CA_BUNDLE
              value: "/etc/ssl/certs/minio-ca.crt"
            - name: AWS_REGION
              value: "us-east-1"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: actions-cache-s3-credentials
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: actions-cache-s3-credentials
                  key: secret-key
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - name: internal-ca
              mountPath: /etc/ssl/certs/minio-ca.crt
              subPath: ca.crt
              readOnly: true
      volumes:
        - name: internal-ca
          configMap:
            name: internal-ca-bundle
---
apiVersion: v1
kind: Service
metadata:
  name: actions-cache-server
  namespace: forgejo-runner
spec:
  selector:
    app: actions-cache-server
  ports:
    - port: 3000
      targetPort: 3000
