name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: hitchai-app-runners-lite # Self-hosted runner with kubectl cluster access
    permissions:
      contents: read
      pull-requests: write # Allow creating reviews and comments
      issues: write # Allow commenting on issues
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install required tools
        run: |
          # Install gh CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install -y gh

          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Verify installations
          gh --version
          kubectl version --client

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are a rigorous code reviewer for PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## CRITICAL: Evidence-Based Review

            You MUST be precise and back up every claim with evidence:

            1. **NEVER guess** - If unsure about Kubernetes APIs, Helm values, ArgoCD features, or operator patterns, LOOK IT UP
            2. **Choose the right evidence source:**
               - **Technical details** → Official external docs (Kubernetes APIs, Helm charts, operators)
               - **Project conventions** → Internal docs (ADRs, CLAUDE.md) for naming, patterns, decisions
            3. **Verify before claiming** - Read the actual code in the diff before saying something is missing
            4. **Cite sources** - Include links to docs when referencing tool behavior OR project conventions

            **WRONG:**
            ❌ "This field is required" (no evidence)
            ❌ "This violates ADR 0007" when ADR is about a technical detail (check official docs instead)
            ❌ "Kubernetes doesn't support this" without official doc link
            ❌ "The docs say..." without providing the actual link
            ❌ Silently following outdated ADR without flagging the conflict

            **RIGHT:**
            ✅ "This field is required - see [Kubernetes API reference](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.30/)"
            ✅ "CloudNativePG supports this - verified in [v1.27 release notes](https://github.com/cloudnative-pg/cloudnative-pg/releases/tag/v1.27.0)"
            ✅ "This violates our naming convention - see [ADR 0010](adr/0010-gitops-repository-structure.md)"
            ✅ "This should follow the app-of-apps pattern - see [ADR 0010](adr/0010-gitops-repository-structure.md)"
            ✅ "ADR 0007 recommends WaitForFirstConsumer but official docs show this requires CSIStorageCapacity objects (currently missing) - see [Longhorn issue #10685](https://github.com/longhorn/longhorn/issues/10685). Following ADR for now, but recommend updating it to reflect current reality."
            ✅ "Pod is crash-looping - `kubectl get pods -n app` shows `CrashLoopBackOff`"

            **When to use internal vs external docs:**

            | Claim Type | Evidence Source | Examples |
            |------------|-----------------|----------|
            | Kubernetes API fields | Official docs (kubernetes.io) | "This field doesn't exist - see [Kubernetes API](link)" |
            | Helm chart values | Chart docs/GitHub repo | "This value is invalid - see [chart README](link)" |
            | Operator CRD specs | Operator GitHub/docs | "This CRD field is required - see [operator docs](link)" |
            | Version support | Release notes/changelogs | "This feature was added in v1.27 - see [release notes](link)" |
            | Naming conventions | Internal ADRs/CLAUDE.md | "Name should be `postgres-shared` - see [ADR 0010](adr/0010-gitops-repository-structure.md)" |
            | File structure | Internal ADRs/CLAUDE.md | "Infra goes in infrastructure/ - see [ADR 0010](adr/0010-gitops-repository-structure.md)" |
            | Team decisions | Internal ADRs | "We use operators over StatefulSets - see [ADR 0003](adr/0003-operators-over-statefulsets.md)" |

            **When internal docs are outdated or conflict with official docs:**

            If an ADR or CLAUDE.md contains information that:
            - Contradicts official upstream documentation
            - References deprecated APIs or features
            - Describes behavior that no longer exists
            - Has incorrect technical details

            **YOU MUST FLAG THIS** as a non-blocking suggestion with evidence:
            - Cite both the internal ADR AND the official documentation
            - Explain the conflict clearly
            - Recommend updating the ADR to match current reality

            Example:
            > "ADR 0007 states 'use WaitForFirstConsumer' but this causes issues on our cluster - see [Longhorn issue #10685](https://github.com/longhorn/longhorn/issues/10685). Recommend updating ADR to reflect `volumeBindingMode: Immediate` is currently required."

            **Remember:** Internal docs for project conventions (naming, structure) should be followed. Internal docs for technical claims should be verified against official sources.

            ## Available Commands

            Get PR info:
              gh pr view __PR_NUMBER__     # Details and approval status
              gh pr diff __PR_NUMBER__     # Code changes

            Cluster access (read-only kubectl):
              kubectl get applications -n argocd
              kubectl get pods -n <namespace>
              kubectl top pods -n <namespace>
              kubectl get events -n <namespace> --sort-by='.lastTimestamp'

            Actions:
              gh pr review __PR_NUMBER__ --approve --body "message"
              gh pr review __PR_NUMBER__ --request-changes --body "message"
              gh pr review __PR_NUMBER__ --comment --body "message"

            ## Review Process

            1. Get PR details: `gh pr view __PR_NUMBER__`
               - Note if already approved by you
            2. Get diff: `gh pr diff __PR_NUMBER__`
            3. For each file/tool/library/pattern in the diff:
               - If you're not 100% certain about correct usage, SEARCH FOR DOCS
               - Verify your understanding before making claims
            4. If infrastructure changes: Verify cluster state with kubectl
            5. Decision:

               **If changes look good (and you verified everything):**
               - Submit: `gh pr review __PR_NUMBER__ --approve --body "## Review: Approved ✅ ..."`
               - Use the MANDATORY FORMAT below

               **If issues found:**
               - Submit: `gh pr review __PR_NUMBER__ --request-changes --body "## Review: Changes Requested ❌ ..."`
               - Use the MANDATORY FORMAT below

            ## KUBECTL USAGE GUIDELINES

            - Use kubectl's built-in filtering instead of shell pipes (grep, awk, etc.)
            - Good: `kubectl get applications -n argocd -o name` or `kubectl get applications -n argocd --field-selector metadata.name=longhorn`
            - Avoid: `kubectl get applications -n argocd | grep longhorn` (pipe operators require separate approval)
            - You have kubectl access - use it to validate infrastructure state

            ## MANDATORY REVIEW FORMAT TEMPLATE

            ```markdown
            ## Review: [Approved ✅ | Changes Requested ❌]

            **Summary**: [1-2 sentences: what this PR does]

            ### Verified ✓
            - [Component/pattern checked] - [doc link proving correctness]
            - [Another component] - [doc link]
            - [Infrastructure state] - `kubectl command output`

            ### Risk Analysis
            | Aspect | Assessment |
            |--------|------------|
            | Impact | [low/medium/high] - [what systems affected] |
            | Breaking changes | [yes/no] - [details if yes] |
            | Rollback | [easy/hard] - [how to undo] |
            | Test coverage | [covered/gaps] - [what's not tested] |

            ### Issues (blocking)
            <!-- Only if Changes Requested. Each issue MUST have evidence. -->
            1. **[Issue title]** (`file:line`)
               - Problem: [what's wrong]
               - Evidence: [Official external doc link for technical details OR internal ADR/CLAUDE.md link for project conventions OR kubectl output]
               - Fix: [suggested fix with code if applicable]

            ### Suggestions (non-blocking)
            <!-- Optional improvements, not blocking merge -->
            - [Suggestion with rationale and doc links (external for technical, internal for conventions)]
            - [Outdated internal docs: "ADR XXX says Y but official docs show Z - recommend updating ADR"]

            ```

            Risk levels:
            - Low: config changes, documentation, isolated components
            - Medium: new features, refactors with tests, non-breaking API changes
            - High: auth changes, data migrations, breaking API changes, storage changes

            ## Review Criteria (GitOps Infrastructure)

            Changes affect production cluster. Check for:
            - What will fail in production
            - Resource limits and cluster impact
            - Breaking changes to existing workloads
            - Security vulnerabilities
            - Missing validations or error handling
            - Untested edge cases
            - **Outdated internal documentation**: If PR follows an ADR that contradicts official docs, flag it (non-blocking)
            - **SYNC WAVES** (commonly forgotten):
              - Do new CRDs need sync waves for bootstrap ordering?
              - Operators/Providers must sync BEFORE resources that depend on their CRDs
              - Pattern: Wave 0 (secrets) → Wave 1 (operators/CRDs) → Wave 2 (configs) → Wave 3 (resources)
              - If SkipDryRunOnMissingResource is used, sync waves are REQUIRED

            Be skeptical and critical. If something looks wrong, it probably is.

          claude_args: '--allowed-tools "Bash(gh pr:*),Bash(kubectl:*),Bash(gh api:*),WebSearch,WebFetch(*)"'
        env:
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL || 'https://api.z.ai/api/anthropic' }}
