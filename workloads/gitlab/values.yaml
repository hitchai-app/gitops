# GitLab Minimal Deployment - Full Feature Set
# Target: ~6-7GB RAM (uses dedicated PostgreSQL, Valkey, MinIO in same namespace)
# Integrates with: Traefik ingress, kube-prometheus-stack observability
# Dedicated services: gitlab-postgres (CloudNativePG), gitlab-valkey, gitlab-minio
# ADR References: 0004, 0005, 0006
# Use Case: New project, small team (5-10 users), all features enabled

global:
  # Domain configuration
  hosts:
    domain: ops.last-try.org
    https: true
    gitlab:
      name: gitlab.ops.last-try.org
    registry:
      name: registry.ops.last-try.org

  # Ingress configuration (Traefik)
  ingress:
    enabled: true
    class: traefik
    provider: traefik  # Required for SSH support (IngressRouteTCP)
    configureCertmanager: false  # Use existing cert-manager
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls:
      enabled: true
      secretName: gitlab-tls

  # Edition
  edition: ce

  # Time zone
  time_zone: UTC

  # Initial root password (will be generated as secret)
  initialRootPassword:
    secret: gitlab-gitlab-initial-root-password
    key: password

  # Email configuration (optional, configure later)
  email:
    from: 'gitlab@ops.last-try.org'
    display_name: GitLab
    reply_to: 'noreply@ops.last-try.org'

  # PostgreSQL (CloudNativePG cluster in same namespace - ADR 0004)
  psql:
    host: gitlab-postgres-rw
    port: 5432
    database: gitlabhq_production
    username: gitlab
    password:
      secret: gitlab-postgres-app
      key: password

  # Redis/Valkey (StatefulSet in same namespace - ADR 0005)
  redis:
    host: gitlab-valkey
    port: 6379

  # MinIO disabled (using object_store with dedicated tenant - ADR 0006)
  minio:
    enabled: false

  # Object storage configuration (all buckets use external MinIO)
  appConfig:
    object_store:
      enabled: true
      proxy_download: true
      connection:
        secret: gitlab-rails-storage
        key: connection
    lfs:
      enabled: true
      bucket: gitlab-lfs
    artifacts:
      enabled: true
      bucket: gitlab-artifacts
    uploads:
      enabled: true
      bucket: gitlab-uploads
    packages:
      enabled: true
      bucket: gitlab-packages
    backups:
      bucket: gitlab-backups
    externalDiffs:
      enabled: true
      bucket: gitlab-mr-diffs
    terraformState:
      enabled: true
      bucket: gitlab-terraform-state
    ciSecureFiles:
      enabled: true
      bucket: gitlab-ci-secure-files
    dependencyProxy:
      enabled: true
      bucket: gitlab-dependency-proxy

# GitLab Rails Components
gitlab:
  # Webservice (main application - API and UI)
  webservice:
    enabled: true
    replicaCount: 1
    resources:
      requests:
        cpu: 500m
        memory: 1.2Gi
      limits:
        cpu: 1500m
        memory: 1.5Gi
    minReplicas: 1
    maxReplicas: 2
    workerProcesses: 2  # Reduced from default 4
    workerTimeout: 60
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: kube-prometheus-stack

  # Sidekiq (background job processor)
  sidekiq:
    enabled: true
    resources:
      requests:
        cpu: 300m
        memory: 900Mi
      limits:
        cpu: 1000m
        memory: 1.2Gi
    minReplicas: 1
    maxReplicas: 2
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: kube-prometheus-stack
    # Single pod handling all queues for minimal deployment
    pods:
      - name: all-in-one
        concurrency: 10  # Reduced from default 20
        queues: ''  # Empty = all queues

  # Gitaly (Git repository storage)
  gitaly:
    enabled: true
    resources:
      requests:
        cpu: 200m
        memory: 800Mi
      limits:
        cpu: 500m
        memory: 1Gi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: kube-prometheus-stack
    persistence:
      enabled: true
      storageClass: longhorn  # Use existing Longhorn
      size: 50Gi
      accessMode: ReadWriteOnce

  # GitLab Shell (SSH access for git)
  gitlab-shell:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 200Mi
      limits:
        cpu: 200m
        memory: 256Mi
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
        additionalLabels:
          release: kube-prometheus-stack

  # Praefect (Gitaly HA - disabled for single node)
  praefect:
    enabled: false

  # Kubernetes Agent Server
  kas:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 200m
        memory: 150Mi
    minReplicas: 1
    maxReplicas: 2

  # GitLab Pages (static site hosting)
  gitlab-pages:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 200m
        memory: 150Mi

  # Mailroom (incoming email)
  mailroom:
    enabled: false  # Disable unless needed

  # Migrations (database schema updates)
  migrations:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 200Mi
      limits:
        cpu: 500m
        memory: 512Mi

  # Toolbox (for backups and maintenance tasks)
  toolbox:
    enabled: true
    resources:
      requests:
        cpu: 50m
        memory: 300Mi
      limits:
        cpu: 500m
        memory: 512Mi
    backups:
      cron:
        enabled: true
        schedule: "0 2 * * *"  # Daily at 2 AM
        persistence:
          enabled: true
          storageClass: longhorn
          size: 10Gi

# Container Registry
registry:
  enabled: true
  resources:
    requests:
      cpu: 200m
      memory: 600Mi
    limits:
      cpu: 500m
      memory: 800Mi
  hpa:
    minReplicas: 1
    maxReplicas: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: kube-prometheus-stack
  # Storage backend (uses bundled MinIO via global.minio)
  storage:
    secret: registry-storage
    key: config
  maintenance:
    uploadPurging:
      enabled: true
      age: 168h  # Delete incomplete uploads after 7 days
      interval: 24h
      dryRun: false

# NGINX Ingress Controller (GitLab internal)
nginx-ingress:
  enabled: false  # We use Traefik

# Bundled PostgreSQL - DISABLED (using external CloudNativePG - ADR 0004)
postgresql:
  install: false

# Bundled Redis - DISABLED (using external Valkey - ADR 0005)
redis:
  install: false

# Bundled MinIO - DISABLED (using external MinIO tenant - ADR 0006)
minio:
  install: false

# Cert-manager - DISABLED (use existing cert-manager with letsencrypt-prod ClusterIssuer)
certmanager-issuer:
  email: ops@last-try.org

# Prometheus (use existing kube-prometheus-stack)
prometheus:
  install: false

# Grafana (use existing from observability stack)
grafana:
  enabled: false

# GitLab Runner (use existing ARC runners)
gitlab-runner:
  install: false

# Shared Secrets
shared-secrets:
  enabled: true
  env: production
  rbac:
    create: true
