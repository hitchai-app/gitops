apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitlab
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # 1. GitLab CR (managed by GitLab Operator)
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab/operator
    # 2. PostgreSQL cluster (CloudNativePG - ADR 0004)
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab/postgres
    # 3. Valkey (Redis-compatible cache - ADR 0005)
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab/valkey
    # 4. MinIO tenant (object storage - ADR 0006)
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab/minio
    # 5. Certificates
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab/certificates
    # 6. Sealed secrets
    - repoURL: https://github.com/hitchai-app/gitops.git
      targetRevision: HEAD
      path: workloads/gitlab
      directory:
        include: "*-sealed.yaml"
  # Ignore K8s default fields added by API server/controllers
  # Prevents OutOfSync for StatefulSet fields like imagePullPolicy, protocol, volumeMode, etc.
  # Reference: https://argo-cd.readthedocs.io/en/stable/user-guide/diffing/
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      name: gitlab-valkey
      namespace: gitlab-system
      managedFieldsManagers:
        - kube-controller-manager
      jqPathExpressions:
        # VolumeClaimTemplate defaults
        - .spec.volumeClaimTemplates[]?.spec.volumeMode
        # Container defaults
        - .spec.template.spec.containers[]?.imagePullPolicy
        - .spec.template.spec.containers[]?.terminationMessagePath
        - .spec.template.spec.containers[]?.terminationMessagePolicy
        - .spec.template.spec.containers[]?.ports[]?.protocol
        # Probe defaults
        - .spec.template.spec.containers[]?.livenessProbe.failureThreshold
        - .spec.template.spec.containers[]?.livenessProbe.successThreshold
        - .spec.template.spec.containers[]?.livenessProbe.timeoutSeconds
        - .spec.template.spec.containers[]?.readinessProbe.failureThreshold
        - .spec.template.spec.containers[]?.readinessProbe.successThreshold
        - .spec.template.spec.containers[]?.readinessProbe.timeoutSeconds
        # Pod spec defaults
        - .spec.template.spec.dnsPolicy
        - .spec.template.spec.restartPolicy
        - .spec.template.spec.schedulerName
        - .spec.template.spec.securityContext
        - .spec.template.spec.terminationGracePeriodSeconds
        # StatefulSet spec defaults
        - .spec.podManagementPolicy
        - .spec.revisionHistoryLimit
        - .spec.updateStrategy
        - .spec.persistentVolumeClaimRetentionPolicy
  destination:
    server: https://kubernetes.default.svc
    namespace: gitlab-system
  syncPolicy:
    automated:
      prune: false  # Manual prune for safety (GitLab is stateful)
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    retry:
      limit: 3
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
