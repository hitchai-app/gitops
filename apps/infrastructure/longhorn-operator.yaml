apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: longhorn-operator
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.longhorn.io
    chart: longhorn
    targetRevision: 1.10.0  # Latest stable (Sept 2025)
    helm:
      valuesObject:
        # Disable pre-upgrade checker for ArgoCD compatibility
        # https://github.com/longhorn/longhorn/issues/8707
        preUpgradeChecker:
          jobEnabled: false

        # Default replica count (single node configuration)
        defaultSettings:
          defaultReplicaCount: "1"
          backupTarget: "s3://longhorn-backups@auto/"
          backupTargetCredentialSecret: "longhorn-backup-secret"

        # Resource limits for Longhorn components
        longhornManager:
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

        longhornDriver:
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi

        longhornUI:
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 128Mi

        # Storage class configuration
        # Note: We create explicit StorageClass manifests in infrastructure/longhorn/
        # This prevents Helm from creating the default "longhorn" StorageClass
        persistence:
          defaultClass: false
          defaultClassReplicaCount: 1

  destination:
    server: https://kubernetes.default.svc
    namespace: longhorn-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
