apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: longhorn-operator
  namespace: argocd
spec:
  project: default
  sources:
    # Helm chart from Longhorn repository
    - repoURL: https://charts.longhorn.io
      chart: longhorn
      targetRevision: 1.10.0  # Latest stable (Sept 2025)
      helm:
        valuesObject:
          # Disable pre-upgrade checker for ArgoCD compatibility
          # https://github.com/longhorn/longhorn/issues/8707
          preUpgradeChecker:
            jobEnabled: false

          # Default replica count (multi-node HA configuration)
          defaultSettings:
            defaultReplicaCount: "2"
            replicaAutoBalance: "best-effort"
            storageOverProvisioningPercentage: "200"
            storageMinimalAvailablePercentage: "25"

          # Backup to Backblaze B2 (S3-compatible, $0.006/GB)
          # Credentials managed by Crossplane (infrastructure/crossplane-providers/b2-longhorn-backup.yaml)
          # Note: Longhorn 1.10+ uses defaultBackupStore instead of defaultSettings.backupTarget
          defaultBackupStore:
            backupTarget: "s3://hitchai-longhorn-backups@us-east-005/"
            backupTargetCredentialSecret: "longhorn-backup-b2-credentials"
            pollInterval: "5m"

          # Resource limits for Longhorn components
          longhornManager:
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi

          longhornDriver:
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 64Mi

          longhornUI:
            replicas: 2
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 128Mi

          # Webhooks/metrics components - 2 replicas for HA
          longhornAdmissionWebhook:
            replicas: 2
          longhornConversionWebhook:
            replicas: 2
          longhornRecoveryBackend:
            replicas: 2

          # CSI sidecars - 2 replicas for HA
          csi:
            attacherReplicaCount: 2
            provisionerReplicaCount: 2
            resizerReplicaCount: 2
            snapshotterReplicaCount: 2

          # Storage class configuration
          # Note: We create explicit StorageClass manifests in infrastructure/longhorn/
          # This prevents Helm from creating the default "longhorn" StorageClass
          persistence:
            defaultClass: false
            defaultClassReplicaCount: 2

    # Additional resources (StorageClasses, OAuth2 Proxy)
    - repoURL: https://github.com/hitchai-app/gitops
      targetRevision: master
      path: infrastructure/longhorn

  destination:
    server: https://kubernetes.default.svc
    namespace: longhorn-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
