apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: longhorn-operator
  namespace: argocd
spec:
  project: default
  sources:
    # Helm chart from Longhorn repository
    - repoURL: https://charts.longhorn.io
      chart: longhorn
      targetRevision: 1.10.0  # Latest stable (Sept 2025)
      helm:
        valuesObject:
          # Disable pre-upgrade checker for ArgoCD compatibility
          # https://github.com/longhorn/longhorn/issues/8707
          preUpgradeChecker:
            jobEnabled: false

          # Default replica count (single node configuration)
          defaultSettings:
            defaultReplicaCount: "1"
            backupTarget: "s3://longhorn-backups@auto/"
            backupTargetCredentialSecret: "longhorn-backup-secret"
            storageOverProvisioningPercentage: "1000"
            storageMinimalAvailablePercentage: "25"

          # Resource limits for Longhorn components
          longhornManager:
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 500m
                memory: 512Mi

          longhornDriver:
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 64Mi

          longhornUI:
            # Single-node: keep UI at 1 replica; revisit when multi-node.
            replicas: 1
            resources:
              requests:
                cpu: 10m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 128Mi

          # Webhooks/metrics components run as Deployments; reduce replicas on single node.
          # TODO: Increase replicas when cluster has multiple nodes.
          longhornAdmissionWebhook:
            replicas: 1
          longhornConversionWebhook:
            replicas: 1
          longhornRecoveryBackend:
            replicas: 1

          # CSI sidecars default to multiple replicas; reduce for single-node capacity.
          # TODO: Increase replicas when cluster has multiple nodes.
          csi:
            attacherReplicaCount: 1
            provisionerReplicaCount: 1
            resizerReplicaCount: 1
            snapshotterReplicaCount: 1

          # Storage class configuration
          # Note: We create explicit StorageClass manifests in infrastructure/longhorn/
          # This prevents Helm from creating the default "longhorn" StorageClass
          persistence:
            defaultClass: false
            defaultClassReplicaCount: 1

    # Additional resources (StorageClasses, OAuth2 Proxy)
    - repoURL: https://github.com/hitchai-app/gitops
      targetRevision: master
      path: infrastructure/longhorn

  destination:
    server: https://kubernetes.default.svc
    namespace: longhorn-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
