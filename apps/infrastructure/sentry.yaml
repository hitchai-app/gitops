# Sentry self-hosted error tracking
# Bundled Kafka/Redis/ClickHouse with external Postgres (CNPG)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sentry
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  sources:
    # Helm chart from sentry-kubernetes community repo
    - repoURL: https://sentry-kubernetes.github.io/charts
      chart: sentry
      targetRevision: 28.0.2
      helm:
        releaseName: sentry
        valueFiles:
          - $values/infrastructure/sentry/values.yaml

    # Git repository with values
    - repoURL: https://github.com/hitchai-app/gitops
      targetRevision: master
      ref: values

    # Git repository with ArgoCD migration hooks
    - repoURL: https://github.com/hitchai-app/gitops
      targetRevision: master
      path: infrastructure/sentry/hooks

  destination:
    server: https://kubernetes.default.svc
    namespace: sentry-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true

  ignoreDifferences:
    # Ignore generated secret data (auto-generated by chart/cert-manager)
    - group: ""
      kind: Secret
      name: sentry-kafka-kraft-cluster-id
      jsonPointers:
        - /data
    - group: ""
      kind: Secret
      name: sentry-nginx-tls
      jsonPointers:
        - /data
    # Ignore defaulted/generated StatefulSet fields
    - group: apps
      kind: StatefulSet
      name: sentry-clickhouse
      jsonPointers:
        - /spec/volumeClaimTemplates
    - group: apps
      kind: StatefulSet
      name: sentry-sentry-redis-master
      jsonPointers:
        - /spec/volumeClaimTemplates
    - group: apps
      kind: StatefulSet
      name: sentry-sentry-redis-replicas
      jsonPointers:
        - /spec/volumeClaimTemplates
    - group: apps
      kind: StatefulSet
      name: sentry-zookeeper-clickhouse
      jsonPointers:
        - /spec/volumeClaimTemplates
    - group: apps
      kind: StatefulSet
      name: sentry-taskbroker-default
      jsonPointers:
        - /spec/volumeClaimTemplates
        - /spec/template/metadata/annotations
    - group: apps
      kind: StatefulSet
      name: sentry-taskbroker-ingest
      jsonPointers:
        - /spec/volumeClaimTemplates
        - /spec/template/metadata/annotations
    - group: apps
      kind: StatefulSet
      name: sentry-taskbroker-long
      jsonPointers:
        - /spec/volumeClaimTemplates
        - /spec/template/metadata/annotations
    - group: apps
      kind: StatefulSet
      name: sentry-taskbroker-products
      jsonPointers:
        - /spec/volumeClaimTemplates
        - /spec/template/metadata/annotations
